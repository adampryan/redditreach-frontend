<app-header></app-header>
<div class="replies-container">
  <header class="page-header">
    <h1>Replies to Your Comments</h1>
    <a mat-button routerLink="/dashboard">
      <mat-icon>arrow_back</mat-icon>
      Back to Dashboard
    </a>
  </header>

  <!-- Stats Cards -->
  <div class="stats-row" *ngIf="stats">
    <mat-card class="stat-card">
      <div class="stat-value">{{ stats.total_replies }}</div>
      <div class="stat-label">Total Replies</div>
    </mat-card>
    <mat-card class="stat-card unread" [class.active]="stats.unread_replies > 0">
      <div class="stat-value">{{ stats.unread_replies }}</div>
      <div class="stat-label">Unread</div>
    </mat-card>
    <mat-card class="stat-card needs-response" [class.active]="stats.needs_response > 0">
      <div class="stat-value">{{ stats.needs_response }}</div>
      <div class="stat-label">Needs Response</div>
    </mat-card>
    <mat-card class="stat-card drafts" [class.active]="stats.pending_drafts > 0">
      <div class="stat-value">{{ stats.pending_drafts }}</div>
      <div class="stat-label">Pending Drafts</div>
    </mat-card>
  </div>

  <!-- Filters Row -->
  <div class="filters-row">
    <mat-form-field appearance="outline" class="filter-select">
      <mat-label>Status</mat-label>
      <mat-select [value]="currentFilter" (selectionChange)="filterBy($event.value)">
        <mat-option *ngFor="let option of filterOptions" [value]="option.value">
          {{ option.label }}
        </mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline" class="subreddit-select" *ngIf="stats && stats.subreddits && stats.subreddits.length">
      <mat-label>Subreddits</mat-label>
      <mat-select [value]="currentSubreddits" (selectionChange)="filterBySubreddits($event.value)" multiple>
        <mat-option *ngFor="let sub of stats!.subreddits" [value]="sub">
          r/{{ sub }}
        </mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline" class="sort-select">
      <mat-label>Sort by</mat-label>
      <mat-select [value]="currentSort" (selectionChange)="sortBy($event.value)">
        <mat-option *ngFor="let option of sortOptions" [value]="option.value">
          {{ option.label }}
        </mat-option>
      </mat-select>
    </mat-form-field>

    <button
      mat-stroked-button
      color="primary"
      class="refresh-button"
      (click)="refreshReplies()"
      [disabled]="isRefreshing">
      <mat-icon *ngIf="!isRefreshing">refresh</mat-icon>
      <mat-spinner *ngIf="isRefreshing" diameter="20"></mat-spinner>
      {{ isRefreshing ? 'Checking...' : 'Check for Replies' }}
    </button>
  </div>

  <!-- Loading -->
  <div *ngIf="isLoading" class="loading-spinner">
    <mat-spinner diameter="40"></mat-spinner>
  </div>

  <!-- Empty State -->
  <mat-card *ngIf="!isLoading && replies.length === 0" class="empty-state">
    <mat-card-content>
      <mat-icon>forum</mat-icon>
      <h2>No replies yet</h2>
      <p *ngIf="currentFilter !== 'all'">Try changing the filter to see more replies.</p>
      <p *ngIf="currentFilter === 'all'">When people reply to your posted comments, they'll appear here.</p>
    </mat-card-content>
  </mat-card>

  <!-- Replies List -->
  <div class="replies-list" *ngIf="!isLoading && replies.length > 0">
    <mat-card
      class="reply-card"
      *ngFor="let reply of replies"
      [class.unread]="!reply.is_read"
      (click)="viewReply(reply.id)">

      <!-- Header -->
      <div class="card-header">
        <div class="header-left">
          <span class="unread-dot" *ngIf="!reply.is_read"></span>
          <span class="subreddit">r/{{ reply.subreddit_name }}</span>
          <span class="op-badge" *ngIf="reply.is_op_reply">
            <mat-icon>star</mat-icon>
            OP
          </span>
          <span class="nested-badge" *ngIf="reply.is_nested">
            <mat-icon>subdirectory_arrow_right</mat-icon>
            Nested
          </span>
        </div>
        <span class="age">{{ getTimeAgo(reply.reply_created_at) }}</span>
      </div>

      <!-- Conversation Thread -->
      <div class="conversation-thread">
        <!-- Original Post Context -->
        <div class="thread-item post-context" *ngIf="reply.original_post_title">
          <div class="thread-line"></div>
          <div class="thread-content">
            <span class="thread-label">Post:</span>
            <span class="thread-text">{{ truncate(reply.original_post_title, 60) }}</span>
          </div>
        </div>

        <!-- Our Comment -->
        <div class="thread-item our-comment">
          <div class="thread-line"></div>
          <div class="thread-content">
            <span class="thread-label">You:</span>
            <span class="thread-text">{{ truncate(reply.our_response_preview, 80) }}</span>
          </div>
        </div>

        <!-- Their Reply (highlighted) -->
        <div class="thread-item their-reply">
          <div class="thread-line last"></div>
          <div class="thread-content highlight">
            <span class="thread-label">
              <mat-icon>person</mat-icon>
              u/{{ reply.reply_author }}:
            </span>
            <span class="thread-text">"{{ truncate(reply.reply_body, 120) }}"</span>
          </div>
        </div>
      </div>

      <!-- Footer -->
      <div class="card-footer">
        <div class="badges">
          <span class="score" [class.positive]="reply.reply_score > 0" [class.negative]="reply.reply_score < 0">
            <mat-icon>{{ reply.reply_score >= 0 ? 'arrow_upward' : 'arrow_downward' }}</mat-icon>
            {{ reply.reply_score }}
          </span>
          <span class="badge needs-response" *ngIf="reply.requires_response">
            <mat-icon>priority_high</mat-icon>
            Needs Response
          </span>
          <span class="badge draft" *ngIf="reply.draft_status === 'draft'">
            <mat-icon>edit_note</mat-icon>
            Draft
          </span>
          <span class="badge approved" *ngIf="reply.draft_status === 'approved'">
            <mat-icon>schedule_send</mat-icon>
            Approved
          </span>
          <span class="badge posted" *ngIf="reply.draft_status === 'posted'">
            <mat-icon>check_circle</mat-icon>
            Posted
          </span>
        </div>
        <div class="card-actions">
          <button
            mat-icon-button
            matTooltip="Dismiss reply"
            (click)="dismissReply(reply, $event)">
            <mat-icon>close</mat-icon>
          </button>
          <mat-icon class="action-arrow">chevron_right</mat-icon>
        </div>
      </div>
    </mat-card>
  </div>

  <!-- Pagination -->
  <mat-paginator
    *ngIf="totalCount > pageSize"
    [length]="totalCount"
    [pageSize]="pageSize"
    [pageIndex]="currentPage - 1"
    (page)="onPageChange($event)"
    showFirstLastButtons>
  </mat-paginator>
</div>
