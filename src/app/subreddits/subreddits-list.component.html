<app-header></app-header>
<div class="subreddits-container">
  <header class="page-header">
    <div class="header-left">
      <h1>Subreddits</h1>
      <span class="usage-badge" *ngIf="stats">
        {{ subreddits.length }} of {{ stats.tier_limits.subreddits }} used
      </span>
    </div>
    <div class="header-right">
      <a mat-button routerLink="/dashboard">
        <mat-icon>arrow_back</mat-icon>
        Dashboard
      </a>
      <button mat-raised-button color="primary" (click)="toggleAddForm()" *ngIf="!showAddForm">
        <mat-icon>add</mat-icon>
        Add Subreddit
      </button>
    </div>
  </header>

  <!-- Add Form -->
  <mat-card class="add-form" *ngIf="showAddForm">
    <mat-card-header>
      <mat-card-title>Add Subreddit</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div class="form-row">
        <mat-form-field appearance="outline">
          <mat-label>Subreddit Name</mat-label>
          <input matInput [(ngModel)]="newSubredditName" (input)="onSubredditNameChange()" placeholder="e.g., baseballcards">
          <span matPrefix>r/</span>
          <mat-hint>Enter a subreddit name to get AI keyword suggestions</mat-hint>
        </mat-form-field>
      </div>

      <!-- Keyword Suggestions -->
      <div class="keyword-suggestions" *ngIf="isLoadingSuggestions || suggestedKeywords.length > 0 || suggestionWarning">
        <div class="suggestions-header">
          <span class="suggestions-label">
            <mat-icon>auto_awesome</mat-icon>
            AI Suggested Keywords
          </span>
          <div class="suggestions-actions" *ngIf="suggestedKeywords.length > 0">
            <button mat-button type="button" (click)="selectAllSuggestions()" [disabled]="selectedSuggestions.size === suggestedKeywords.length">
              Select All
            </button>
            <button mat-button type="button" (click)="clearSuggestions()" [disabled]="selectedSuggestions.size === 0">
              Clear
            </button>
          </div>
        </div>

        <div class="suggestions-loading" *ngIf="isLoadingSuggestions">
          <mat-spinner diameter="20"></mat-spinner>
          <span>Analyzing subreddit...</span>
        </div>

        <div class="suggestions-warning" *ngIf="suggestionWarning && !isLoadingSuggestions">
          <mat-icon>warning</mat-icon>
          {{ suggestionWarning }}
        </div>

        <div class="suggestions-chips" *ngIf="suggestedKeywords.length > 0 && !isLoadingSuggestions">
          <mat-chip-listbox multiple>
            <mat-chip-option
              *ngFor="let kw of suggestedKeywords"
              [selected]="selectedSuggestions.has(kw)"
              (click)="toggleSuggestion(kw)">
              {{ kw }}
            </mat-chip-option>
          </mat-chip-listbox>
        </div>

        <div class="suggestions-reasoning" *ngIf="suggestionReasoning && !isLoadingSuggestions">
          <mat-icon>lightbulb</mat-icon>
          {{ suggestionReasoning }}
        </div>
      </div>

      <div class="form-row">
        <mat-form-field appearance="outline">
          <mat-label>Keywords</mat-label>
          <input matInput [(ngModel)]="newKeywords" placeholder="e.g., grading, PSA, vintage">
          <mat-hint>Comma-separated keywords to match relevant posts</mat-hint>
        </mat-form-field>
      </div>
      <div class="error-message" *ngIf="addError">
        <mat-icon>error</mat-icon>
        {{ addError }}
      </div>
    </mat-card-content>
    <mat-card-actions>
      <button mat-raised-button color="primary" (click)="addSubreddit()" [disabled]="isSubmitting">
        <mat-spinner *ngIf="isSubmitting" diameter="18"></mat-spinner>
        <span *ngIf="!isSubmitting">Add Subreddit</span>
      </button>
      <button mat-button (click)="toggleAddForm()">Cancel</button>
    </mat-card-actions>
  </mat-card>

  <!-- Edit Form -->
  <mat-card class="edit-form" *ngIf="editingSubreddit">
    <mat-card-header>
      <mat-card-title>Edit r/{{ editingSubreddit.subreddit_name }}</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div class="form-row">
        <mat-form-field appearance="outline">
          <mat-label>Keywords</mat-label>
          <input matInput [(ngModel)]="editKeywords" placeholder="e.g., grading, PSA, vintage">
          <mat-hint>Comma-separated keywords to match relevant posts</mat-hint>
        </mat-form-field>
      </div>
      <div class="form-row">
        <mat-form-field appearance="outline">
          <mat-label>Exclude Keywords</mat-label>
          <input matInput [(ngModel)]="editExcludeKeywords" placeholder="e.g., selling, FS, WTS">
          <mat-hint>Posts containing these words will be skipped</mat-hint>
        </mat-form-field>
      </div>
      <div class="form-row">
        <mat-form-field appearance="outline">
          <mat-label>Max Responses Per Day</mat-label>
          <input matInput type="number" [(ngModel)]="editMaxResponsesPerDay" min="1" max="10">
          <mat-hint>Limit daily responses to avoid looking spammy</mat-hint>
        </mat-form-field>
      </div>
      <div class="error-message" *ngIf="editError">
        <mat-icon>error</mat-icon>
        {{ editError }}
      </div>
    </mat-card-content>
    <mat-card-actions>
      <button mat-raised-button color="primary" (click)="saveEdit()" [disabled]="isUpdating">
        <mat-spinner *ngIf="isUpdating" diameter="18"></mat-spinner>
        <span *ngIf="!isUpdating">Save Changes</span>
      </button>
      <button mat-button (click)="cancelEdit()">Cancel</button>
    </mat-card-actions>
  </mat-card>

  <!-- Loading -->
  <div *ngIf="isLoading" class="loading-spinner">
    <mat-spinner diameter="40"></mat-spinner>
  </div>

  <!-- Empty State -->
  <mat-card *ngIf="!isLoading && subreddits.length === 0 && !showAddForm" class="empty-state">
    <mat-card-content>
      <mat-icon>forum</mat-icon>
      <h2>No subreddits yet</h2>
      <p>Add subreddits to start finding opportunities.</p>
      <button mat-raised-button color="primary" (click)="toggleAddForm()">
        <mat-icon>add</mat-icon>
        Add Your First Subreddit
      </button>
    </mat-card-content>
  </mat-card>

  <!-- Subreddits List -->
  <div class="subreddits-list" *ngIf="!isLoading && subreddits.length > 0">
    <mat-card *ngFor="let sub of subreddits" class="subreddit-card" [class.inactive]="!sub.is_active">
      <div class="card-main">
        <div class="subreddit-info">
          <div class="subreddit-name">
            r/{{ sub.subreddit_name }}
            <mat-chip *ngIf="!sub.is_active" class="inactive-chip">Paused</mat-chip>
          </div>
          <div class="keywords" *ngIf="sub.keywords?.length">
            <mat-chip *ngFor="let keyword of sub.keywords">{{ keyword }}</mat-chip>
          </div>
        </div>
        <div class="subreddit-stats">
          <div class="stat">
            <span class="value">{{ sub.total_opportunities_found }}</span>
            <span class="label">Opportunities</span>
          </div>
          <div class="stat">
            <span class="value">{{ sub.total_responses_posted }}</span>
            <span class="label">Posted</span>
          </div>
          <div class="stat">
            <span class="value">{{ sub.responses_today }}/{{ sub.max_responses_per_day }}</span>
            <span class="label">Today</span>
          </div>
        </div>
      </div>
      <div class="card-footer">
        <span class="last-scanned">
          <mat-icon>schedule</mat-icon>
          Scanned {{ getLastScanned(sub.last_scanned) }}
        </span>
        <div class="actions">
          <button mat-icon-button matTooltip="Edit" (click)="startEdit(sub)">
            <mat-icon>edit</mat-icon>
          </button>
          <button mat-icon-button [matTooltip]="sub.is_active ? 'Pause' : 'Resume'" (click)="toggleActive(sub)">
            <mat-icon>{{ sub.is_active ? 'pause' : 'play_arrow' }}</mat-icon>
          </button>
          <button mat-icon-button matTooltip="Delete" color="warn" (click)="deleteSubreddit(sub)">
            <mat-icon>delete</mat-icon>
          </button>
        </div>
      </div>
    </mat-card>
  </div>
</div>
