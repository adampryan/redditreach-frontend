<div class="billing-container">
  <app-header></app-header>

  <header class="page-header">
    <div>
      <h1>Billing & Plans</h1>
      <p class="subtitle">Choose the plan that's right for your business</p>
    </div>
    <a mat-button routerLink="/dashboard">
      <mat-icon>arrow_back</mat-icon>
      Dashboard
    </a>
  </header>

  <!-- Loading -->
  <div *ngIf="isLoading" class="loading-spinner">
    <mat-spinner diameter="40"></mat-spinner>
  </div>

  <ng-container *ngIf="!isLoading">
    <!-- Success/Error Messages -->
    <div class="message success" *ngIf="successMessage">
      <mat-icon>check_circle</mat-icon>
      {{ successMessage }}
      <button mat-icon-button (click)="successMessage = ''">
        <mat-icon>close</mat-icon>
      </button>
    </div>
    <div class="message error" *ngIf="checkoutError">
      <mat-icon>error</mat-icon>
      {{ checkoutError }}
      <button mat-icon-button (click)="checkoutError = ''">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <!-- Current Subscription -->
    <mat-card class="current-plan-card" *ngIf="billingStatus?.has_subscription || (billingStatus?.subscription_tier && billingStatus?.subscription_tier !== 'trial')">
      <mat-card-header>
        <mat-card-title>Current Subscription</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="current-plan-info">
          <div class="plan-details">
            <span class="plan-name">{{ currentPlan?.name || billingStatus?.subscription_tier }}</span>
            <span class="plan-price">${{ currentPlan?.price }}/month</span>
          </div>
          <div class="plan-status">
            <span class="status-badge" [ngClass]="billingStatus?.subscription_status">
              {{ billingStatus?.subscription_status }}
            </span>
            <span class="renewal-date" *ngIf="billingStatus?.current_period_end">
              {{ billingStatus?.cancel_at_period_end ? 'Ends' : 'Renews' }} {{ formatDate(billingStatus?.current_period_end ?? null) }}
            </span>
          </div>
        </div>
        <div class="subscription-actions">
          <button mat-stroked-button (click)="manageSubscription()">
            <mat-icon>credit_card</mat-icon>
            Manage Billing
          </button>

          <!-- Resume button if cancelling -->
          <button
            *ngIf="billingStatus?.cancel_at_period_end"
            mat-raised-button
            color="primary"
            (click)="resumeSubscription()"
            [disabled]="isCancelling">
            <mat-icon>replay</mat-icon>
            {{ isCancelling ? 'Resuming...' : 'Stay with us!' }}
          </button>

          <!-- Cancel button if active -->
          <button
            *ngIf="!billingStatus?.cancel_at_period_end && !showCancelConfirm"
            mat-button
            color="warn"
            (click)="showCancelConfirm = true">
            Need a break?
          </button>
        </div>

        <!-- Cancel/Pause options -->
        <div class="cancel-confirm" *ngIf="showCancelConfirm">
          <p>We get it, life happens! What would you like to do?</p>

          <div class="pause-option">
            <div class="option-info">
              <strong>Take a breather</strong>
              <span>Pause for 1-3 months. We'll keep your settings safe.</span>
            </div>
            <button
              mat-stroked-button
              color="primary"
              (click)="pauseSubscription()"
              [disabled]="isCancelling">
              {{ isCancelling ? 'Processing...' : 'Pause subscription' }}
            </button>
          </div>

          <div class="cancel-option">
            <div class="option-info">
              <strong>Say goodbye (for now)</strong>
              <span>Cancel entirely. Access continues until {{ formatDate(billingStatus?.current_period_end ?? null) }}.</span>
            </div>
            <button
              mat-stroked-button
              color="warn"
              (click)="cancelSubscription()"
              [disabled]="isCancelling">
              {{ isCancelling ? 'Processing...' : 'Cancel subscription' }}
            </button>
          </div>

          <div class="cancel-actions">
            <button mat-button (click)="showCancelConfirm = false">Never mind, I'll stay!</button>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Trial Notice -->
    <mat-card class="trial-card" *ngIf="billingStatus?.subscription_tier === 'trial'" [class.expired]="billingStatus?.is_trial_expired">
      <mat-card-content>
        <mat-icon class="trial-icon">{{ billingStatus?.is_trial_expired ? 'timer_off' : 'hourglass_empty' }}</mat-icon>
        <div class="trial-text">
          <ng-container *ngIf="billingStatus?.is_trial_expired; else trialActive">
            <strong>Your trial has ended</strong>
            <p>Subscribe now to resume monitoring and never miss a conversation.</p>
          </ng-container>
          <ng-template #trialActive>
            <strong *ngIf="billingStatus?.trial_days_remaining !== null">
              {{ billingStatus?.trial_days_remaining }} day{{ billingStatus?.trial_days_remaining === 1 ? '' : 's' }} left in your trial
            </strong>
            <strong *ngIf="billingStatus?.trial_days_remaining === null">You're on the free trial</strong>
            <p>Upgrade to a paid plan to keep catching threads after your trial ends.</p>
          </ng-template>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Plans Grid -->
    <div class="plans-grid">
      <mat-card
        *ngFor="let plan of plans"
        class="plan-card"
        [class.current]="isCurrentPlan(plan.tier)"
        [class.popular]="plan.tier === 'growth' && billingStatus?.subscription_tier === 'starter'">

        <div class="popular-badge" *ngIf="plan.tier === 'growth' && billingStatus?.subscription_tier === 'starter'">Most Popular</div>

        <mat-card-header>
          <mat-card-title>{{ plan.name }}</mat-card-title>
          <div class="price">
            <span class="amount">${{ plan.price }}</span>
            <span class="period">/month</span>
          </div>
        </mat-card-header>

        <mat-card-content>
          <ul class="features">
            <li *ngFor="let feature of plan.features">
              <mat-icon>check</mat-icon>
              {{ feature }}
            </li>
          </ul>
        </mat-card-content>

        <mat-card-actions>
          <button
            *ngIf="!isCurrentPlan(plan.tier)"
            mat-raised-button
            [color]="plan.tier === 'growth' && (billingStatus?.subscription_tier === 'starter' || billingStatus?.subscription_tier === 'trial') ? 'primary' : ''"
            (click)="subscribe(plan.tier)"
            [disabled]="isCheckingOut">
            <mat-spinner *ngIf="isCheckingOut" diameter="18"></mat-spinner>
            <span *ngIf="!isCheckingOut">
              {{ getButtonText(plan) }}
            </span>
          </button>
          <button
            *ngIf="isCurrentPlan(plan.tier)"
            mat-stroked-button
            disabled>
            Current Plan
          </button>
        </mat-card-actions>
      </mat-card>
    </div>

    <!-- FAQ -->
    <mat-card class="faq-card">
      <mat-card-header>
        <mat-card-title>Frequently Asked Questions</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="faq-item">
          <strong>Can I cancel anytime?</strong>
          <p>Yes, you can cancel your subscription at any time. You'll continue to have access until the end of your billing period.</p>
        </div>
        <div class="faq-item">
          <strong>What happens when I reach my limits?</strong>
          <p>You'll still see opportunities but won't be able to approve new responses until your limits reset at the start of your billing period.</p>
        </div>
        <div class="faq-item">
          <strong>Can I upgrade or downgrade?</strong>
          <p>Yes, you can change your plan at any time. Changes take effect immediately and are prorated.</p>
        </div>
      </mat-card-content>
    </mat-card>
  </ng-container>
</div>
