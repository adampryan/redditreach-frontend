<app-header></app-header>
<div class="opportunities-container">
  <header class="page-header">
    <div class="header-left">
      <h1>Opportunities</h1>
      <div class="last-loaded" *ngIf="stats?.last_scanned">
        <span class="last-loaded-text">Last scanned: {{ stats!.last_scanned | date:'shortTime' }}</span>
        <button mat-icon-button (click)="refresh()" [disabled]="isLoading" class="refresh-btn" title="Refresh">
          <mat-icon [class.spinning]="isLoading">refresh</mat-icon>
        </button>
      </div>
    </div>
    <a mat-button routerLink="/dashboard">
      <mat-icon>arrow_back</mat-icon>
      Back to Dashboard
    </a>
  </header>

  <!-- Stats Cards -->
  <div class="stats-row" *ngIf="stats">
    <mat-card class="stat-card" [class.active]="stats.total > 0">
      <div class="stat-value">{{ stats.total }}</div>
      <div class="stat-label">Total</div>
    </mat-card>
    <mat-card class="stat-card unread" [class.active]="stats.unread > 0">
      <div class="stat-value">{{ stats.unread }}</div>
      <div class="stat-label">Unread</div>
    </mat-card>
    <mat-card class="stat-card pending" [class.active]="stats.pending_approval > 0">
      <div class="stat-value">{{ stats.pending_approval }}</div>
      <div class="stat-label">Ready to Review</div>
    </mat-card>
    <mat-card class="stat-card posted" [class.active]="stats.posted > 0">
      <div class="stat-value">{{ stats.posted }}</div>
      <div class="stat-label">Posted</div>
    </mat-card>
  </div>

  <!-- Filters Row -->
  <div class="filters-row">
    <mat-form-field appearance="outline" class="filter-select">
      <mat-label>Status</mat-label>
      <mat-select [(value)]="currentStatus" (selectionChange)="filterByStatus(currentStatus)">
        <mat-option *ngFor="let filter of statusFilters" [value]="filter.value">
          {{ filter.label }}
        </mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline" class="filter-select">
      <mat-label>Intent Tier</mat-label>
      <mat-select [(value)]="currentIntentTier" (selectionChange)="onIntentTierChange()">
        <mat-option *ngFor="let filter of intentTierFilters" [value]="filter.value">
          {{ filter.label }}
        </mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline" class="filter-select">
      <mat-label>Drafts</mat-label>
      <mat-select [(value)]="currentHasDrafts" (selectionChange)="onHasDraftsChange()">
        <mat-option *ngFor="let filter of draftFilters" [value]="filter.value">
          {{ filter.label }}
        </mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline" class="subreddit-select" *ngIf="stats && stats.subreddits && stats.subreddits.length > 0">
      <mat-label>Subreddits</mat-label>
      <mat-select [(value)]="currentSubreddits" (selectionChange)="onSubredditsChange()" multiple>
        <mat-option *ngFor="let sub of stats!.subreddits" [value]="sub">
          r/{{ sub }}
        </mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="outline" class="sort-select">
      <mat-label>Sort</mat-label>
      <mat-select [(value)]="currentSort" (selectionChange)="onSortChange()">
        <mat-option *ngFor="let option of sortOptions" [value]="option.value">
          {{ option.label }}
        </mat-option>
      </mat-select>
    </mat-form-field>
  </div>

  <!-- Bulk Actions Bar -->
  <div class="bulk-actions-bar" *ngIf="opportunities.length > 0">
    <mat-checkbox
      [checked]="selectAll"
      [indeterminate]="selectedIds.size > 0 && selectedIds.size < opportunities.length"
      (change)="toggleSelectAll()">
      <span *ngIf="selectedIds.size > 0">{{ selectedIds.size }} selected</span>
      <span *ngIf="selectedIds.size === 0">Select all</span>
    </mat-checkbox>

    <div class="bulk-buttons" *ngIf="hasSelections">
      <button mat-flat-button color="primary" (click)="bulkGenerate()" [disabled]="isGenerating || !canBulkGenerate">
        <mat-icon>auto_awesome</mat-icon>
        <span *ngIf="!isGenerating">Generate Responses</span>
        <span *ngIf="isGenerating">Generating...</span>
      </button>
      <button mat-flat-button color="accent" (click)="bulkApprove()" [disabled]="!canBulkApprove">
        <mat-icon>check_circle</mat-icon>
        Approve Selected
      </button>
      <button mat-stroked-button (click)="bulkMarkRead()">
        <mat-icon>done</mat-icon>
        Mark Read
      </button>
      <button mat-stroked-button color="warn" (click)="bulkReject()">
        <mat-icon>close</mat-icon>
        Reject
      </button>
      <button mat-stroked-button (click)="bulkRestore()" *ngIf="currentStatus === 'rejected'">
        <mat-icon>restore</mat-icon>
        Restore
      </button>
    </div>
  </div>

  <!-- Loading -->
  <div *ngIf="isLoading" class="loading-spinner">
    <mat-spinner diameter="40"></mat-spinner>
  </div>

  <!-- Empty State -->
  <mat-card *ngIf="!isLoading && opportunities.length === 0" class="empty-state">
    <mat-card-content>
      <mat-icon>search_off</mat-icon>
      <h2>No opportunities found</h2>
      <p *ngIf="currentStatus && currentStatus !== 'all'">Try changing the filter to see more opportunities.</p>
      <p *ngIf="!currentStatus || currentStatus === 'all'">Opportunities will appear here once we find relevant Reddit posts.</p>
    </mat-card-content>
  </mat-card>

  <!-- Opportunities List -->
  <div class="opportunities-list" *ngIf="!isLoading && opportunities.length > 0">
    <mat-card
      class="opportunity-card"
      *ngFor="let opp of opportunities"
      [class.unread]="!opp.is_read"
      [class.selected]="isSelected(opp.id)"
      (click)="viewOpportunity(opp)">

      <div class="card-content">
        <mat-checkbox
          class="row-checkbox"
          [checked]="isSelected(opp.id)"
          (click)="toggleSelection(opp.id, $event)">
        </mat-checkbox>

        <div class="card-main">
          <div class="card-header">
            <div class="header-left">
              <span class="unread-dot" *ngIf="!opp.is_read"></span>
              <span class="subreddit">r/{{ opp.subreddit_name }}</span>
            </div>
            <span class="age">{{ getTimeAgo(opp.age_hours) }}</span>
          </div>

          <div class="card-title">{{ opp.post_title }}</div>

          <div class="card-body" *ngIf="opp.post_body_preview">
            {{ truncateText(opp.post_body_preview, 150) }}
          </div>

          <div class="card-meta">
            <span class="author">u/{{ opp.post_author }}</span>
            <div class="stats">
              <span class="score" [class.positive]="opp.post_score > 0" [class.negative]="opp.post_score < 0">
                <mat-icon>arrow_upward</mat-icon>
                {{ opp.post_score }}
              </span>
              <span class="comments">
                <mat-icon>chat_bubble_outline</mat-icon>
                {{ opp.post_num_comments }}
              </span>
              <span class="tier-badge" *ngIf="opp.intent_tier" [ngClass]="getTierClass(opp.intent_tier)">
                {{ formatIntentTier(opp.intent_tier) }}
              </span>
              <span class="relevance" *ngIf="opp.relevance_score">
                {{ (opp.relevance_score * 100).toFixed(0) }}%
              </span>
            </div>
          </div>

          <div class="card-footer">
            <div class="badges">
              <span class="status" [ngClass]="getStatusClass(opp.status)">
                {{ formatStatus(opp.status) }}
              </span>
              <span class="badge drafts" *ngIf="opp.has_drafts" (click)="toggleDraftPreview(opp.id, $event)">
                <mat-icon>description</mat-icon>
                {{ opp.draft_count }} Draft{{ opp.draft_count > 1 ? 's' : '' }}
                <mat-icon class="expand-icon">{{ isDraftExpanded(opp.id) ? 'expand_less' : 'expand_more' }}</mat-icon>
              </span>
              <span class="badge scheduled" *ngIf="opp.scheduled_for">
                <mat-icon>schedule</mat-icon>
                {{ formatScheduledTime(opp.scheduled_for) }}
              </span>
            </div>
            <mat-icon class="action-arrow">chevron_right</mat-icon>
          </div>

          <!-- Collapsible Draft Preview -->
          <div class="draft-preview-section" *ngIf="opp.has_drafts && isDraftExpanded(opp.id)" (click)="$event.stopPropagation()">
            <div class="draft-preview-header">
              <mat-icon>edit_note</mat-icon>
              <span>Draft Preview</span>
            </div>
            <div class="draft-preview-text">
              {{ opp.draft_preview }}
            </div>
            <div class="draft-preview-actions">
              <button mat-button color="primary" (click)="viewOpportunity(opp)">
                <mat-icon>visibility</mat-icon>
                View All Drafts
              </button>
            </div>
          </div>
        </div>
      </div>
    </mat-card>
  </div>

  <!-- Pagination -->
  <mat-paginator
    *ngIf="totalCount > pageSize"
    [length]="totalCount"
    [pageSize]="pageSize"
    [pageIndex]="currentPage - 1"
    (page)="onPageChange($event)"
    showFirstLastButtons>
  </mat-paginator>
</div>
