<app-header></app-header>
<div class="detail-container">
  <!-- Loading -->
  <div *ngIf="isLoading" class="loading-spinner">
    <mat-spinner diameter="40"></mat-spinner>
  </div>

  <ng-container *ngIf="!isLoading && opportunity">
    <!-- Header -->
    <header class="detail-header">
      <button mat-icon-button (click)="goBack()">
        <mat-icon>arrow_back</mat-icon>
      </button>
      <div class="header-info">
        <span class="subreddit">r/{{ opportunity.subreddit_name }}</span>
        <span class="status" [ngClass]="getStatusClass(opportunity.status)">
          {{ formatStatus(opportunity.status) }}
        </span>
        <span class="scheduled-badge" *ngIf="opportunity.scheduled_for && opportunity.status === 'approved'">
          <mat-icon>schedule</mat-icon>
          {{ formatScheduledTime(opportunity.scheduled_for) }}
        </span>
      </div>
    </header>

    <!-- Scheduled Post Info -->
    <mat-card class="scheduled-card" *ngIf="opportunity.scheduled_for && opportunity.status === 'approved'">
      <mat-card-content>
        <mat-icon>schedule</mat-icon>
        <div class="scheduled-info">
          <strong>Scheduled to Post</strong>
          <p>This response will be automatically posted {{ formatScheduledTime(opportunity.scheduled_for) }}.</p>
          <span class="scheduled-datetime">{{ opportunity.scheduled_for | date:'medium' }}</span>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Reddit Post -->
    <mat-card class="post-card">
      <mat-card-header>
        <mat-card-title>{{ opportunity.post_title }}</mat-card-title>
        <mat-card-subtitle>
          Posted by u/{{ opportunity.post_author }}
          <span class="post-stats">
            <mat-icon>arrow_upward</mat-icon> {{ opportunity.post_score }}
            <mat-icon>chat_bubble_outline</mat-icon> {{ opportunity.post_num_comments }}
          </span>
        </mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <div class="post-body" *ngIf="opportunity.post_body">
          {{ opportunity.post_body }}
        </div>
        <div class="relevance-info">
          <strong>Relevance:</strong> {{ (opportunity.relevance_score * 100).toFixed(0) }}%
          <span class="relevance-reason" *ngIf="opportunity.relevance_reasoning">
            - {{ opportunity.relevance_reasoning }}
          </span>
        </div>
        <div class="keywords" *ngIf="opportunity.detected_keywords?.length">
          <mat-chip *ngFor="let keyword of opportunity.detected_keywords">{{ keyword }}</mat-chip>
        </div>
      </mat-card-content>
      <mat-card-actions>
        <button mat-button color="primary" (click)="openRedditPost()">
          <mat-icon>open_in_new</mat-icon>
          View on Reddit
        </button>
      </mat-card-actions>
    </mat-card>

    <!-- Posted Response (if already posted) -->
    <mat-card class="posted-card" *ngIf="opportunity.posted_response">
      <mat-card-header>
        <mat-card-title>Posted Response</mat-card-title>
        <mat-card-subtitle>
          Posted {{ opportunity.posted_response.posted_at | date:'medium' }}
          by u/{{ opportunity.posted_response.posted_by_username }}
        </mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <div class="response-text">{{ opportunity.posted_response.final_text }}</div>
        <div class="response-stats">
          <span><mat-icon>arrow_upward</mat-icon> {{ opportunity.posted_response.comment_score }}</span>
          <span><mat-icon>reply</mat-icon> {{ opportunity.posted_response.reply_count }} replies</span>
          <span *ngIf="opportunity.posted_response.was_removed" class="removed">
            <mat-icon>warning</mat-icon> Removed
          </span>
        </div>
      </mat-card-content>
      <mat-card-actions>
        <a mat-button color="primary" [href]="opportunity.posted_response.reddit_comment_url" target="_blank">
          <mat-icon>open_in_new</mat-icon>
          View Comment
        </a>
      </mat-card-actions>
    </mat-card>

    <!-- Draft Selection (if has drafts) -->
    <ng-container *ngIf="opportunity.drafts.length > 0">
      <!-- Expired Post Warning -->
      <mat-card class="expired-warning" *ngIf="!opportunity.is_respondable && opportunity.status !== 'posted'">
        <mat-card-content>
          <mat-icon>schedule</mat-icon>
          <div>
            <strong>Post Too Old</strong>
            <p>This Reddit post is over 7 days old and can no longer receive responses. The drafts below are for reference only.</p>
          </div>
        </mat-card-content>
      </mat-card>

      <div class="section-header">
        <h2 class="section-title">{{ opportunity.is_respondable ? 'Select a Response' : 'Generated Responses (Expired)' }}</h2>
        <button
          mat-stroked-button
          color="primary"
          (click)="openRegenerateDialog()"
          [disabled]="isRegenerating || !opportunity.is_respondable"
          *ngIf="opportunity.is_respondable">
          <mat-spinner *ngIf="isRegenerating" diameter="18"></mat-spinner>
          <mat-icon *ngIf="!isRegenerating">autorenew</mat-icon>
          {{ isRegenerating ? 'Generating...' : 'Generate New' }}
        </button>
      </div>

      <div class="drafts-list">
        <mat-card
          *ngFor="let draft of opportunity.drafts"
          class="draft-card"
          [class.selected]="selectedDraft?.id === draft.id"
          [class.disabled]="!opportunity.is_respondable"
          (click)="opportunity.is_respondable && selectDraft(draft)">
          <div class="draft-header">
            <span class="draft-label">{{ draft.variation_label }}</span>
            <mat-icon *ngIf="selectedDraft?.id === draft.id && opportunity.is_respondable">check_circle</mat-icon>
          </div>
          <div class="draft-text">{{ draft.response_text }}</div>
        </mat-card>
      </div>

      <!-- Edit Mode (only if respondable) -->
      <div class="edit-section" *ngIf="selectedDraft && opportunity.is_respondable">
        <div class="edit-header">
          <h3>Your Response</h3>
          <button mat-button (click)="toggleEditMode()">
            <mat-icon>{{ showEditMode ? 'visibility' : 'edit' }}</mat-icon>
            {{ showEditMode ? 'Preview' : 'Edit' }}
          </button>
        </div>

        <mat-form-field *ngIf="showEditMode" appearance="outline" class="edit-textarea">
          <textarea
            matInput
            [(ngModel)]="editedText"
            rows="8"
            placeholder="Edit your response..."></textarea>
        </mat-form-field>

        <div *ngIf="!showEditMode" class="preview-text">
          {{ editedText }}
        </div>
      </div>

      <!-- Scheduling (only if respondable) -->
      <div class="schedule-section" *ngIf="opportunity.is_respondable">
        <mat-checkbox [(ngModel)]="schedulePost">Schedule for later</mat-checkbox>
        <div class="schedule-inputs" *ngIf="schedulePost">
          <mat-form-field appearance="outline">
            <mat-label>Date</mat-label>
            <input matInput type="date" [(ngModel)]="scheduledDate" [min]="minDate">
          </mat-form-field>
          <mat-form-field appearance="outline">
            <mat-label>Time</mat-label>
            <input matInput type="time" [(ngModel)]="scheduledTime">
          </mat-form-field>
        </div>
      </div>

      <!-- Action Buttons (only if respondable) -->
      <div class="action-buttons" *ngIf="opportunity.is_respondable">
        <button
          mat-raised-button
          color="primary"
          (click)="approve()"
          [disabled]="isSubmitting || !selectedDraft">
          <mat-icon>{{ schedulePost ? 'schedule' : 'check' }}</mat-icon>
          {{ schedulePost ? 'Schedule Post' : 'Approve & Post' }}
        </button>
        <button
          mat-stroked-button
          color="warn"
          (click)="reject()"
          [disabled]="isSubmitting">
          <mat-icon>close</mat-icon>
          Reject
        </button>
      </div>
    </ng-container>

    <!-- No Drafts Message -->
    <mat-card *ngIf="opportunity.is_respondable && opportunity.drafts.length === 0" class="no-drafts">
      <mat-card-content>
        <mat-icon>{{ isRegenerating ? 'autorenew' : 'hourglass_empty' }}</mat-icon>
        <p *ngIf="!isRegenerating">Response drafts are being generated. Check back shortly.</p>
        <p *ngIf="isRegenerating">Generating response...</p>
        <button
          mat-raised-button
          color="primary"
          (click)="openRegenerateDialog()"
          [disabled]="isRegenerating"
          *ngIf="!isRegenerating">
          <mat-icon>autorenew</mat-icon>
          Generate Now
        </button>
      </mat-card-content>
    </mat-card>
  </ng-container>
</div>
